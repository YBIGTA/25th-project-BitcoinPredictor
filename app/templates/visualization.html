<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candlestick Chart</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #333;
        }

        #controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        #candlestick-chart {
            width: 100%;
            max-width: 1200px;
            height: 80vh; /* 화면 크기에 따라 반응형 크기 */
        }

        #timeframe-controls {
            margin-bottom: 20px;
        }

        #legend {
            margin-top: 20px;
            display: flex;
            flex-direction: row;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color-box {
            width: 20px;
            height: 20px;
        }
        #chart-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            margin: 0 auto;
        }

        /* 돋보기 및 축소 버튼을 차트의 오른쪽 위로 배치 */
        #zoom-button, #reset-button {
            position: absolute;
            top: 10px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            z-index: 10; /* 버튼이 차트 위에 나타나도록 설정 */
        }

        #zoom-button {
            right: 70px; /* 오른쪽에서 약간 왼쪽으로 */
        }

        #reset-button {
            right: 10px; /* 오른쪽 끝에 위치 */
        }
        #controls {
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap; /* 버튼과 입력 필드가 겹치지 않도록 수정 */
}

#candlestick-chart {
    width: 100%;
    max-width: 1200px;
    height: 60vh; /* 차트 크기 조정 */
}

#rsi-chart {
    width: 100%;
    max-width: 1200px;
    height: 30vh; /* RSI 차트 크기 조정 */
    margin-top: 30px; /* 차트 간격 추가 */
}

#chart-container {
    position: relative;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
}
    </style>
</head>
<body>    
    <h1>Bitcoin Price Chart</h1>
    <div id="controls">
        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <label for="start-date">Start Date:</label>
                <input type="date" id="start-date">
            </div>
            
            <div style="display: flex; flex-direction: column; align-items: center;">
                <label for="end-date">End Date:</label>
                <input type="date" id="end-date">
            </div>
            
            <button onclick="updateChart()">Update Chart</button>
        </div>
    </div>

    <div id="timeframe-controls" style="text-align: center; margin-top: 20px;">
        <button onclick="setTimeframe('minute')">분봉</button>
        <button onclick="setTimeframe('day')">일봉</button>
        <button onclick="setTimeframe('week')">주봉</button>
    </div>
    <!-- 차트 컨테이너 추가 -->
    <div id="chart-container">
        <!-- 돋보기 버튼 추가 -->
        <button id="zoom-button" onclick="zoomToThreeMonths()">🔍</button>
        <!-- 축소 버튼 추가 -->
        <button id="reset-button" onclick="resetChart()">🔄</button>
        <div id="candlestick-chart"></div>
        <div id="rsi-chart" style="margin-top: 30px;"></div> <!-- RSI 차트를 위한 div 추가 -->
    </div>

    
    <script>
        let selectedTimeframe = 'week';
        let zoomedStartDate = null;
        let zoomedEndDate = null;

        function setTimeframe(timeframe) {
            selectedTimeframe = timeframe;
            if (zoomedStartDate && zoomedEndDate) {
                updateChart(zoomedStartDate, zoomedEndDate);
            } else {
                updateChart();
            }
        }

        async function fetchData(startDate = null, endDate = null) {
            let url = `/predict?timeframe=${selectedTimeframe}`;
            if (startDate && endDate) {
                url += `&start_date=${startDate}&end_date=${endDate}`;
            }
            const response = await fetch(url);
            const json = await response.json();
            return json.data;
        }

        async function updateChart(startDate = null, endDate = null) {
            const selectedStartDate = document.getElementById('start-date').value || startDate;
            const selectedEndDate = document.getElementById('end-date').value || endDate;

            const data = await fetchData(selectedStartDate, selectedEndDate);

            if (data.length === 0) {
                document.getElementById('candlestick-chart').innerHTML = "<p>No data available for the selected date range.</p>";
                return;
            }

            const dates = data.map(row => row.Date);
            const opens = data.map(row => row.Open);
            const highs = data.map(row => row.High);
            const lows = data.map(row => row.Low);
            const closes = data.map(row => row.Close);
            const volumes = data.map(row => row.Volume);
            const ma20 = data.map(row => row.MA20);
            const ma60 = data.map(row => row.MA60);
            const rsi = data.map(row => row.RSI);

            const traceCandlestick = {
                x: dates,
                close: closes,
                decreasing: {line: {color: 'red'}},
                high: highs,
                increasing: {line: {color: 'blue'}},
                low: lows,
                open: opens,
                type: 'candlestick',
                xaxis: 'x',
                yaxis: 'y'
            };

            const traceVolume = {
                x: dates,
                y: volumes,
                type: 'bar',
                yaxis: 'y2',
                marker: {color: 'rgba(100, 150, 250, 0.4)'},
                name: 'Volume'
            };

            const traceMA20 = {
                x: dates,
                y: ma20,
                type: 'scatter',
                mode: 'lines',
                line: {color: 'blue'},
                name: 'MA20'
            };

            const traceMA60 = {
                x: dates,
                y: ma60,
                type: 'scatter',
                mode: 'lines',
                line: {color: 'orange'},
                name: 'MA60'
            };


            const traceRSI = {
                x: dates,
                y: rsi,
                type: 'scatter',
                mode: 'lines',
                line: {color: 'purple'},
                name: 'RSI'
            };
            const layoutCandlestick = {
                title: `Bitcoin Price - ${selectedTimeframe.toUpperCase()}`,
                xaxis: {title: 'Date'},
                yaxis: {title: 'Price'},
                // yaxis2: {title: 'Volume', overlaying: 'y', side: 'right'},
                showlegend: true,
                responsive: true,
                height: 450, // 캔들 차트의 높이 조정
            };


            const layoutRSI = {
                title: 'RSI',
                xaxis: {title: 'Date'},
                yaxis: {title: 'RSI', range: [0, 100]},
                showlegend: true,
                responsive: true,
                height: 200,
                margin: {
                    t: 20,
                    b: 20
                }
            };

        Plotly.newPlot('candlestick-chart', [traceCandlestick,traceMA20, traceMA60], layoutCandlestick);
        Plotly.newPlot('rsi-chart', [traceRSI], layoutRSI);}

        async function zoomToThreeMonths() {
            selectedTimeframe = 'day';
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(endDate.getMonth() - 3);

            zoomedStartDate = startDate.toISOString().split('T')[0];
            zoomedEndDate = endDate.toISOString().split('T')[0];

            updateChart(zoomedStartDate, zoomedEndDate);
        }

        async function resetChart() {
            selectedTimeframe = 'week';
            zoomedStartDate = null;
            zoomedEndDate = null;

            updateChart();
        }

        updateChart();
    </script>
</body>
</html>